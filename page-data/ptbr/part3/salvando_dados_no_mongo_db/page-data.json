{"componentChunkName":"component---src-templates-content-template-js","path":"/ptbr/part3/salvando_dados_no_mongo_db","result":{"data":{"markdownRemark":{"html":"<div class=\"content\">\n<p>Antes de irmos ao assunto principal sobre persistência de dados em um banco de dados, vamos dar uma olhada em algumas maneiras diferentes de depurar aplicações Node.</p>\n<h3>Depurando aplicações Node</h3>\n<p>A depuração de aplicações Node é um tanto mais difícil do que depurar JavaScript em execução no navegador. A impressão de dados no console é um método testado e comprovado, e sempre vale a pena utilizá-lo. Algumas pessoas acham que métodos mais sofisticados devem ser usados ​​em vez do console, mas eu discordo. Até os melhores desenvolvedores <i>open-source</i> do mundo <a href=\"https://tenderlovemaking.com/2016/02/05/i-am-a-puts-debuggerer.html\">usam</a> esse <a href=\"https://swizec.com/blog/javascript-debugging-slightly-beyond-consolelog/\">método</a>.</p>\n<h4>Visual Studio Code</h4>\n<p>O depurador do Visual Studio Code pode ser útil em algumas situações. Você pode iniciar a aplicação no modo de depuração assim:</p>\n<picture><img src=\"/static/b97b10a73a2a6404f05e73cc9eaff622/5a190/35x.png\" alt=\"captura de tela mostrando a forma de iniciar o depurador no VS Code\" srcset=\"/static/b97b10a73a2a6404f05e73cc9eaff622/772e8/35x.png 200w,\n/static/b97b10a73a2a6404f05e73cc9eaff622/e17e5/35x.png 400w,\n/static/b97b10a73a2a6404f05e73cc9eaff622/5a190/35x.png 800w,\n/static/b97b10a73a2a6404f05e73cc9eaff622/c1b63/35x.png 1200w,\n/static/b97b10a73a2a6404f05e73cc9eaff622/29007/35x.png 1600w,\n/static/b97b10a73a2a6404f05e73cc9eaff622/c658e/35x.png 2202w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Observe que a aplicação não deve estar em execução em outro console, caso contrário, a porta já estará em uso.</p>\n<p><strong>Obs.:</strong> Uma versão mais recente do Visual Studio Code pode ter <em>Run</em> em vez de <em>Debug</em>. Além disso, talvez você precise configurar seu arquivo <em>launch.json</em> para iniciar a depuração. Isso pode ser feito selecionando <em>Add Configuration...</em> no menu, que está localizado ao lado do botão verde de play e acima do menu <em>VARIABLES</em>, selecionando <em>Run \"npm start\" in a debug terminal</em>. Para instruções de configuração mais detalhadas, leia a <a href=\"https://code.visualstudio.com/docs/editor/debugging\">documentação sobre depuração</a> do Visual Studio Code.</p>\n<p>Abaixo você pode ver uma captura de tela onde a execução do código foi interrompida no meio do salvamento uma nova nota:</p>\n<picture><img src=\"/static/feed4fe57ce10ff79881a5cbd155026b/5a190/36x.png\" alt=\"captura de tela do vscode mostrando a execução em um ponto de parada\" srcset=\"/static/feed4fe57ce10ff79881a5cbd155026b/772e8/36x.png 200w,\n/static/feed4fe57ce10ff79881a5cbd155026b/e17e5/36x.png 400w,\n/static/feed4fe57ce10ff79881a5cbd155026b/5a190/36x.png 800w,\n/static/feed4fe57ce10ff79881a5cbd155026b/c1b63/36x.png 1200w,\n/static/feed4fe57ce10ff79881a5cbd155026b/29007/36x.png 1600w,\n/static/feed4fe57ce10ff79881a5cbd155026b/7e9b1/36x.png 2252w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>A execução parou no <i>ponto de parada</i> (breakpoint) na linha 69. É possível ver no console o valor da variável <i>note</i>. Na janela superior esquerda, é possível ver outras coisas relacionadas ao estado da aplicação.</p>\n<p>As setas na parte superior podem ser usadas para controlar o fluxo do depurador.</p>\n<p>Por alguma razão, eu não uso muito o depurador do Visual Studio Code.</p>\n<h4>As Ferramentas do Desenvolvedor do Chrome</h4>\n<p>Também é possível depurar o código com o Console do Desenvolvedor do Chrome, iniciando a aplicação com o comando:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">node</span> <span class=\"token parameter variable\">--inspect</span> index.js</code></pre></div>\n<p>É possível acessar o depurador clicando no ícone verde — o logotipo do Node — que aparece no console de desenvolvedor do Chrome:</p>\n<picture><img src=\"/static/98eea9ee4f184a484417314745f7422a/5a190/37.png\" alt=\"ferramentas do desenvolvedor com o logotipo verde do node\" srcset=\"/static/98eea9ee4f184a484417314745f7422a/772e8/37.png 200w,\n/static/98eea9ee4f184a484417314745f7422a/e17e5/37.png 400w,\n/static/98eea9ee4f184a484417314745f7422a/5a190/37.png 800w,\n/static/98eea9ee4f184a484417314745f7422a/c1b63/37.png 1200w,\n/static/98eea9ee4f184a484417314745f7422a/29007/37.png 1600w,\n/static/98eea9ee4f184a484417314745f7422a/bf286/37.png 1688w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>A visualização da depuração funciona da mesma maneira que fazíamos com as aplicações React. A guia <i>Fontes</i> (Sources) pode ser usada para definir pontos de parada onde a execução do código será pausada.</p>\n<picture><img src=\"/static/55e5f6c8afb83433a723a0da5c575a32/5a190/38eb.png\" alt=\"ferramentas do desenvolvedor - ponto de interrupção na guia fontes e variáveis sendo monitoradas\" srcset=\"/static/55e5f6c8afb83433a723a0da5c575a32/772e8/38eb.png 200w,\n/static/55e5f6c8afb83433a723a0da5c575a32/e17e5/38eb.png 400w,\n/static/55e5f6c8afb83433a723a0da5c575a32/5a190/38eb.png 800w,\n/static/55e5f6c8afb83433a723a0da5c575a32/c1b63/38eb.png 1200w,\n/static/55e5f6c8afb83433a723a0da5c575a32/29007/38eb.png 1600w,\n/static/55e5f6c8afb83433a723a0da5c575a32/828bd/38eb.png 2310w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Todas as mensagens do <i>console.log</i> da aplicação aparecerão na guia <i>Console</i> do depurador. Também é possível inspecionar valores de variáveis e executar seu próprio código JavaScript.</p>\n<picture><img src=\"/static/f4ab60bfb4c362e50561a48eb231a212/5a190/39ea.png\" alt=\"ferramentas do desenvolvedor - guia console mostrando o objeto de nota digitado\" srcset=\"/static/f4ab60bfb4c362e50561a48eb231a212/772e8/39ea.png 200w,\n/static/f4ab60bfb4c362e50561a48eb231a212/e17e5/39ea.png 400w,\n/static/f4ab60bfb4c362e50561a48eb231a212/5a190/39ea.png 800w,\n/static/f4ab60bfb4c362e50561a48eb231a212/c1b63/39ea.png 1200w,\n/static/f4ab60bfb4c362e50561a48eb231a212/29007/39ea.png 1600w,\n/static/f4ab60bfb4c362e50561a48eb231a212/baa75/39ea.png 1746w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<h4>Questione tudo!</h4>\n<p>Depurar aplicações Full Stack pode parecer complicado no início. Em breve, nossa aplicação também terá um banco de dados além do frontend e backend, e haverá muitas áreas potenciais para erros na aplicação.</p>\n<p>Quando a aplicação \"não funciona\", primeiro precisamos descobrir onde o problema realmente está. É muito comum que o problema esteja em um lugar onde você menos esperava, e pode levar minutos, horas ou até mesmo dias antes de encontrar a fonte do problema.</p>\n<p>O segredo é ser sistemático. Como o problema pode existir em qualquer lugar, <i>você deve questionar tudo</i> e eliminar todas as possibilidades uma por uma. Impressão de logs no console, Postman, depuradores e experiência ajudarão.</p>\n<p>Quando bugs acontecem, <i>a pior de todas as estratégias possíveis</i> é continuar escrevendo mais código. Isso garantirá que seu código gere ainda mais bugs para frente, e depurá-los será ainda mais difícil. O princípio <a href=\"http://gettingtolean.com/toyota-principle-5-build-culture-stopping-fix/\">pare e corrija</a> do <i>Toyota Production Systems</i> também é muito eficaz nessa situação.</p>\n<h3>MongoDB</h3>\n<p>Para armazenar indefinidamente nossas notas que estão sendo salvas, precisamos de um banco de dados. A maioria dos cursos ministrados na Universidade de Helsinque utiliza bancos de dados relacionais. Usaremos na maior parte deste curso o <a href=\"https://www.mongodb.com/\">MongoDB</a>, que é um tipo de <a href=\"https://en.wikipedia.org/wiki/Document-oriented_database\">banco de dados de documentos</a> (document database).</p>\n<p>A razão para usar o Mongo como banco de dados é devido a sua menor complexidade em comparação com um banco de dados relacional. A <a href=\"/ptbr/part13\">Parte 13</a> do curso mostra como construir backends em Node.js que usam um banco de dados relacional.</p>\n<p>Bancos de dados de documentos diferem de bancos de dados relacionais em como eles organizam dados, bem como nas linguagens de consulta (query languages) que suportam. Bancos de dados de documentos são geralmente categorizados sob o termo genérico <a href=\"https://en.wikipedia.org/wiki/NoSQL\">NoSQL</a> (Not Only SQL [Não Somente SQL]).</p>\n<p>É possível ler mais sobre bancos de dados de documentos e NoSQL no material do curso para a <a href=\"https://tikape-s18.mooc.fi/part7/\">7ª semana</a> do curso de Introdução a Bancos de Dados. Infelizmente, o material está atualmente disponível apenas em finlandês.</p>\n<p>Leia agora os capítulos sobre <a href=\"https://docs.mongodb.com/manual/core/databases-and-collections/\">coleções</a> (collections) e <a href=\"https://docs.mongodb.com/manual/core/document/\">documentos</a> (documents) do manual do MongoDB para ter uma ideia básica de como um banco de dados de documentos armazena dados.</p>\n<p>Naturalmente, é possível instalar e executar o MongoDB em seu computador. Porém, a internet também está cheia de serviços de banco de dados Mongo que você pode usar. O provedor MongoDB preferido neste curso será o <a href=\"https://www.mongodb.com/atlas/database\">MongoDB Atlas</a>.</p>\n<p>Depois de criar e fazer login em sua conta, vamos começar selecionando o plano gratuito:</p>\n<picture><img src=\"/static/51357385d765c59103d23a83d7faa2ab/5a190/mongo1.png\" alt=\"implantação no mongodb um banco de dados em nuvem gratuito compartilhado\" srcset=\"/static/51357385d765c59103d23a83d7faa2ab/772e8/mongo1.png 200w,\n/static/51357385d765c59103d23a83d7faa2ab/e17e5/mongo1.png 400w,\n/static/51357385d765c59103d23a83d7faa2ab/5a190/mongo1.png 800w,\n/static/51357385d765c59103d23a83d7faa2ab/c1b63/mongo1.png 1200w,\n/static/51357385d765c59103d23a83d7faa2ab/29007/mongo1.png 1600w,\n/static/51357385d765c59103d23a83d7faa2ab/c9d77/mongo1.png 1964w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Escolha o provedor de nuvem e a localização e crie o <i>cluster</i> (grupo, aglomerado):</p>\n<picture><img src=\"/static/d2dda03313ee41bc9018c9b251bac78b/5a190/mongo2.png\" alt=\"escolha compartilhada do mongodb, aws e região\" srcset=\"/static/d2dda03313ee41bc9018c9b251bac78b/772e8/mongo2.png 200w,\n/static/d2dda03313ee41bc9018c9b251bac78b/e17e5/mongo2.png 400w,\n/static/d2dda03313ee41bc9018c9b251bac78b/5a190/mongo2.png 800w,\n/static/d2dda03313ee41bc9018c9b251bac78b/c1b63/mongo2.png 1200w,\n/static/d2dda03313ee41bc9018c9b251bac78b/29007/mongo2.png 1600w,\n/static/d2dda03313ee41bc9018c9b251bac78b/a2ef2/mongo2.png 1970w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Vamos esperar o cluster ficar pronto para uso. Isso pode levar alguns minutos.</p>\n<p><strong>Obs.:</strong> não continue antes que o cluster esteja pronto.</p>\n<p>Vamos usar a guia <i>security</i> (segurança) para criar credenciais de usuário para o banco de dados. Observe que essas não são as mesmas credenciais que você usa para fazer login no MongoDB Atlas. Essas serão usadas para que sua aplicação se conecte ao banco de dados.</p>\n<picture><img src=\"/static/d5226e7c66302ac8515a99fc279a30c0/5a190/mongo3.png\" alt=\"início rápido de segurança do mongodb\" srcset=\"/static/d5226e7c66302ac8515a99fc279a30c0/772e8/mongo3.png 200w,\n/static/d5226e7c66302ac8515a99fc279a30c0/e17e5/mongo3.png 400w,\n/static/d5226e7c66302ac8515a99fc279a30c0/5a190/mongo3.png 800w,\n/static/d5226e7c66302ac8515a99fc279a30c0/c1b63/mongo3.png 1200w,\n/static/d5226e7c66302ac8515a99fc279a30c0/29007/mongo3.png 1600w,\n/static/d5226e7c66302ac8515a99fc279a30c0/2ed34/mongo3.png 1776w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Em seguida, temos que definir os endereços IP que têm permissão de acesso ao banco de dados. Visando simplicidade, permitiremos o acesso de todos os endereços IP:</p>\n<picture><img src=\"/static/2b4e712ca068f1a9b972d3d8130ac98c/5a190/mongo4.png\" alt=\"acesso à rede mongodb/adicionar lista de acesso ip\" srcset=\"/static/2b4e712ca068f1a9b972d3d8130ac98c/772e8/mongo4.png 200w,\n/static/2b4e712ca068f1a9b972d3d8130ac98c/e17e5/mongo4.png 400w,\n/static/2b4e712ca068f1a9b972d3d8130ac98c/5a190/mongo4.png 800w,\n/static/2b4e712ca068f1a9b972d3d8130ac98c/c1b63/mongo4.png 1200w,\n/static/2b4e712ca068f1a9b972d3d8130ac98c/29007/mongo4.png 1600w,\n/static/2b4e712ca068f1a9b972d3d8130ac98c/8deec/mongo4.png 2136w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Observação: Se o menu modal for diferente para você, de acordo com a documentação do MongoDB, adicione 0.0.0.0 como o IP e allow access from anywhere (permitir acesso de qualquer lugar).</p>\n<p>Por fim, estamos prontos para nos conectar ao nosso banco de dados. Comece clicando em <i>connect</i> (conectar).</p>\n<picture><img src=\"/static/5ad5a9afe14fc584c22d3c9bb202f1c2/5a190/mongo5.png\" alt=\"mongodb database deployment connect\" srcset=\"/static/5ad5a9afe14fc584c22d3c9bb202f1c2/772e8/mongo5.png 200w,\n/static/5ad5a9afe14fc584c22d3c9bb202f1c2/e17e5/mongo5.png 400w,\n/static/5ad5a9afe14fc584c22d3c9bb202f1c2/5a190/mongo5.png 800w,\n/static/5ad5a9afe14fc584c22d3c9bb202f1c2/c1b63/mongo5.png 1200w,\n/static/5ad5a9afe14fc584c22d3c9bb202f1c2/29007/mongo5.png 1600w,\n/static/5ad5a9afe14fc584c22d3c9bb202f1c2/8c48a/mongo5.png 2096w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>e escolha: <i>Connect your application</i> (Conecte sua aplicação):</p>\n<picture><img src=\"/static/c5263c7ff5c69b9ba60c08a9fc7054cb/5a190/mongo6.png\" alt=\"conexão à aplicação do mongodb\" srcset=\"/static/c5263c7ff5c69b9ba60c08a9fc7054cb/772e8/mongo6.png 200w,\n/static/c5263c7ff5c69b9ba60c08a9fc7054cb/e17e5/mongo6.png 400w,\n/static/c5263c7ff5c69b9ba60c08a9fc7054cb/5a190/mongo6.png 800w,\n/static/c5263c7ff5c69b9ba60c08a9fc7054cb/c1b63/mongo6.png 1200w,\n/static/c5263c7ff5c69b9ba60c08a9fc7054cb/10ab7/mongo6.png 1552w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>A imagem exibe o <i>URI do MongoDB</i>, que é o endereço do banco de dados que forneceremos à biblioteca-cliente do MongoDB que adicionaremos à nossa aplicação.</p>\n<p>O endereço se parece com isso:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">mongodb+srv://fullstack:thepasswordishere@cluster0.o1opl.mongodb.net/?retryWrites<span class=\"token operator\">=</span>true<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">w</span><span class=\"token operator\">=</span>majority</code></pre></div>\n<p>Estamos prontos para usar o banco de dados.</p>\n<p>Poderíamos usar o banco de dados diretamente do nosso código JavaScript com a biblioteca oficial <a href=\"https://mongodb.github.io/node-mongodb-native/\">MongoDB Node.js Driver</a>, mas ela é bastante complicada de usar. Em vez disso, usaremos a biblioteca <a href=\"http://mongoosejs.com/index.html\">Mongoose</a>, que oferece uma API de alto nível.</p>\n<p>Mongoose poderia ser descrito como um <i>mapeador de documento-objeto</i> (ODM [object document mapper]), que permite salvar diretamente objetos JavaScript como documentos Mongo.</p>\n<p>Vamos instalar o Mongoose:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> mongoose</code></pre></div>\n<p>Ainda não vamos adicionar nenhum código relacionado ao Mongo em nosso backend. Em vez disso, vamos fazer uma aplicação prática criando um novo arquivo, <i>mongo.js</i>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> mongoose <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'mongoose'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span>argv<span class=\"token punctuation\">.</span>length<span class=\"token operator\">&lt;</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'give password as argument'</span><span class=\"token punctuation\">)</span>\n  process<span class=\"token punctuation\">.</span><span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> password <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>argv<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span>\n  <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">mongodb+srv://fullstack:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>password<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">@cluster0.o1opl.mongodb.net/?retryWrites=true&amp;w=majority</span><span class=\"token template-punctuation string\">`</span></span>\n\nmongoose<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'strictQuery'</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\nmongoose<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> noteSchema <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">mongoose<span class=\"token punctuation\">.</span>Schema</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">content</span><span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">important</span><span class=\"token operator\">:</span> Boolean<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> Note <span class=\"token operator\">=</span> mongoose<span class=\"token punctuation\">.</span><span class=\"token function\">model</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Note'</span><span class=\"token punctuation\">,</span> noteSchema<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> note <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Note</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">content</span><span class=\"token operator\">:</span> <span class=\"token string\">'HTML is Easy'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">important</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\nnote<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'note saved!'</span><span class=\"token punctuation\">)</span>\n  mongoose<span class=\"token punctuation\">.</span>connection<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><strong>Obs.:</strong> Dependendo da região que você selecionou ao criar seu cluster, o <i>URI do MongoDB</i> pode ser diferente do exemplo fornecido acima. Você deve verificar e usar o URI correto que foi gerado pelo MongoDB Atlas.</p>\n<p>O código também assume que será passada a senha das credenciais que criamos no MongoDB Atlas como um parâmetro de linha de comando. Podemos acessar o parâmetro da linha de comando assim:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> password <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>argv<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>Quando o código é executado com o comando <i>node mongo.js password</i>, o Mongo adicionará um novo documento ao banco de dados.</p>\n<p><strong>Obs.:</strong> Observe que a senha usada é a senha criada para o usuário do banco de dados, não a senha do MongoDB Atlas. Além disso, se criou uma senha com caracteres especiais, então você precisará <a href=\"https://docs.atlas.mongodb.com/troubleshoot-connection/#special-characters-in-connection-string-password\">codificar por cento sua senha (também conhecido como codificação URL ou URL encoding)</a>.</p>\n<p>Podemos visualizar o estado atual do banco de dados do MongoDB Atlas a partir da guia <i>Browse collections</i>, na opção <i>Databases</i>.</p>\n<picture><img src=\"/static/b306a428691177d5c227d0ba06a0789d/5a190/mongo7.png\" alt=\"botão de navegação de coleções de bancos de dados mongodb\" srcset=\"/static/b306a428691177d5c227d0ba06a0789d/772e8/mongo7.png 200w,\n/static/b306a428691177d5c227d0ba06a0789d/e17e5/mongo7.png 400w,\n/static/b306a428691177d5c227d0ba06a0789d/5a190/mongo7.png 800w,\n/static/b306a428691177d5c227d0ba06a0789d/c1b63/mongo7.png 1200w,\n/static/b306a428691177d5c227d0ba06a0789d/29007/mongo7.png 1600w,\n/static/b306a428691177d5c227d0ba06a0789d/565cc/mongo7.png 1806w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Como a imagem indica, o <i>document</i> (documento) correspondente à nota foi adicionado à coleção <i>notes</i> no banco de dados <i>myFirstDatabase</i>.</p>\n<picture><img src=\"/static/65545b25fe221a6bd9af9912d448710f/5a190/mongo8new.png\" alt=\"guia de coleções do mongodb - &#x27;notes&#x27; no banco de dados &#x27;myFirstDatabase&#x27;\" srcset=\"/static/65545b25fe221a6bd9af9912d448710f/772e8/mongo8new.png 200w,\n/static/65545b25fe221a6bd9af9912d448710f/e17e5/mongo8new.png 400w,\n/static/65545b25fe221a6bd9af9912d448710f/5a190/mongo8new.png 800w,\n/static/65545b25fe221a6bd9af9912d448710f/c1b63/mongo8new.png 1200w,\n/static/65545b25fe221a6bd9af9912d448710f/29007/mongo8new.png 1600w,\n/static/65545b25fe221a6bd9af9912d448710f/d2782/mongo8new.png 1864w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Vamos excluir o banco de dados padrão <i>test</i> e mudar o nome do banco de dados referenciado em nossa string de conexão para <i>noteApp</i>, modificando o URI:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span>\n  <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">mongodb+srv://fullstack:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>password<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">@cluster0.o1opl.mongodb.net/noteApp?retryWrites=true&amp;w=majority</span><span class=\"token template-punctuation string\">`</span></span></code></pre></div>\n<p>Vamos executar novamente nosso código:</p>\n<picture><img src=\"/static/48b29d59fab590d9ca5a326cdd334149/5a190/mongo9.png\" alt=\"guia de coleções mongodb - &#x27;noteApp notes&#x27;\" srcset=\"/static/48b29d59fab590d9ca5a326cdd334149/772e8/mongo9.png 200w,\n/static/48b29d59fab590d9ca5a326cdd334149/e17e5/mongo9.png 400w,\n/static/48b29d59fab590d9ca5a326cdd334149/5a190/mongo9.png 800w,\n/static/48b29d59fab590d9ca5a326cdd334149/c1b63/mongo9.png 1200w,\n/static/48b29d59fab590d9ca5a326cdd334149/29007/mongo9.png 1600w,\n/static/48b29d59fab590d9ca5a326cdd334149/80cfc/mongo9.png 1844w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Os dados agora estão armazenados no banco de dados correto. A visualização também oferece a funcionalidade <i>create database</i> (criar banco de dados), que pode ser usada para criar novos bancos de dados a partir da plataforma. Não é necessário criar um banco de dados dessa forma, pois o MongoDB Atlas cria automaticamente um novo banco de dados quando uma aplicação tenta se conectar a um banco de dados que ainda não existe.</p>\n<h3>Esquema (Schema)</h3>\n<p>Depois de estabelecer a conexão com o banco de dados, definimos o <a href=\"http://mongoosejs.com/docs/guide.html\">schema</a> (esquema) para uma nota e o <a href=\"http://mongoosejs.com/docs/models.html\">model</a> (modelo) correspondente:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> noteSchema <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">mongoose<span class=\"token punctuation\">.</span>Schema</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">content</span><span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">important</span><span class=\"token operator\">:</span> Boolean<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> Note <span class=\"token operator\">=</span> mongoose<span class=\"token punctuation\">.</span><span class=\"token function\">model</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Note'</span><span class=\"token punctuation\">,</span> noteSchema<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Primeiro, definimos o <a href=\"http://mongoosejs.com/docs/guide.html\">schema</a> de uma nota que é armazenada na variável <em>noteSchema</em>. O esquema informa ao Mongoose como os objetos de nota devem ser armazenados no banco de dados.</p>\n<p>Na definição do modelo <em>Note</em>, o primeiro parâmetro <i>\"Note\"</i> é o nome singular do modelo. O nome da coleção será o plural <i>notes</i> em minúsculo, porque a <a href=\"http://mongoosejs.com/docs/models.html\">convenção do Mongoose</a> estabelece a nomeação automática de coleções com o seu plural (por exemplo, <i>notes</i>) quando o esquema se refere a elas no singular (por exemplo, <i>Note</i>).</p>\n<p>Bancos de dados de documentos como o Mongo são <i>schemaless</i> (sem esquema), o que significa que o banco de dados em si não se importa com a estrutura dos dados armazenados no banco de dados. É possível armazenar documentos com campos completamente diferentes na mesma coleção.</p>\n<p>A ideia por trás do Mongoose é que os dados armazenados no banco de dados recebam um <i>esquema no nível da aplicação</i> que define a forma dos documentos armazenados em qualquer coleção.</p>\n<h3>Criando e salvando objetos</h3>\n<p>Em seguida, a aplicação cria um novo objeto de nota com a ajuda do <a href=\"http://mongoosejs.com/docs/models.html\">modelo</a> <i>Note</i>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> note <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Note</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">content</span><span class=\"token operator\">:</span> <span class=\"token string\">'HTML is Easy'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">important</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Modelos são chamados de <i>funções construtoras</i> (constructor functions) que criam novos objetos JavaScript com base nos parâmetros fornecidos. Como os objetos são criados com a função construtora do modelo, eles herdam todas as propriedades do modelo, que incluem métodos para salvar o objeto no banco de dados.</p>\n<p>O salvamento do objeto no banco de dados ocorre com o método apropriadamente chamado <em>save</em>, que pode ser fornecido com um gerenciador de evento com o método <em>then</em>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">note<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'note saved!'</span><span class=\"token punctuation\">)</span>\n  mongoose<span class=\"token punctuation\">.</span>connection<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Quando o objeto é salvo no banco de dados, o gerenciador de evento fornecido para <em>then</em> é chamado. O gerenciador de evento fecha a conexão do banco de dados com o comando <code>mongoose.connection.close()</code>. Se a conexão não for fechada, o programa nunca terminará sua execução.</p>\n<p>O resultado da operação de salvamento está no parâmetro <em>result</em> do gerenciador de evento. O resultado não é lá muito interessante quando estamos armazenando um objeto no banco de dados. Você pode imprimir o objeto no console se quiser examiná-lo mais de perto enquanto implementa sua aplicação ou durante a depuração.</p>\n<p>Vamos também salvar algumas notas adicionais modificando os dados no código e executando o programa novamente.</p>\n<p><strong>Obs.:</strong> Infelizmente, a documentação do Mongoose não é muito consistente: usam callbacks em alguns de seus exemplos; em outras partes, outros estilos. Portanto, não é recomendado copiar e colar o código diretamente de lá. Misturar promessas com callbacks antigos no mesmo código não é recomendado. </p>\n<h3>Recuperando objetos do banco de dados</h3>\n<p>Vamos comentar o código que gera novas notas e adicionemos o seguinte:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">Note<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  result<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">note</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  mongoose<span class=\"token punctuation\">.</span>connection<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Quando o código é executado, o programa imprime todas as notas armazenadas no banco de dados:</p>\n<picture><img src=\"/static/e71d12d6187f8507bbbe598b9cef6972/5a190/70new.png\" alt=\"node mongo.js imprime notas no formato JSON\" srcset=\"/static/e71d12d6187f8507bbbe598b9cef6972/772e8/70new.png 200w,\n/static/e71d12d6187f8507bbbe598b9cef6972/e17e5/70new.png 400w,\n/static/e71d12d6187f8507bbbe598b9cef6972/5a190/70new.png 800w,\n/static/e71d12d6187f8507bbbe598b9cef6972/18539/70new.png 1074w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Os objetos são recuperados do banco de dados com o método <a href=\"https://mongoosejs.com/docs/api/model.html#model_Model-find\">find</a> do modelo <em>Note</em>. O parâmetro do método é um objeto que expressa condições de pesquisa. Como o parâmetro é um objeto vazio<code>{}</code>, obtemos todas as notas armazenadas na coleção  <em>notes</em>.</p>\n<p>As condições de pesquisa aderem à <a href=\"https://docs.mongodb.com/manual/reference/operator/\">sintaxe</a> de consulta do Mongo.</p>\n<p>Podemos restringir nossa pesquisa incluindo apenas notas importantes:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">Note<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">important</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n</div>\n<div class=\"tasks\">\n<h3>Exercício 3.12</h3>\n<h4>3.12: Command-line database</h4>\n<p>Crie um banco de dados MongoDB em nuvem com o MongoDB Atlas para a aplicação da lista telefônica.</p>\n<p>Crie um arquivo <i>mongo.js</i> no diretório do projeto, que pode ser usado para adicionar entradas à lista telefônica e listar todas as entradas existentes na lista telefônica.</p>\n<p><strong>Obs.:</strong> Não inclua sua senha no arquivo que você enviará ao GitHub!</p>\n<p>A aplicação deve funcionar da seguinte maneira: o programa é usado através de três argumentos de linha de comando (o primeiro é a senha). Por exemplo:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">node</span> mongo.js suasenha Anna 040-1234556</code></pre></div>\n<p>Como resultado, a aplicação imprimirá:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">added Anna number 040-1234556 to phonebook</code></pre></div>\n<p>A nova entrada na lista telefônica será salva no banco de dados. Observe que, se o nome contiver caracteres de espaço em branco, o mesmo deverá ser colocado entre aspas:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">node</span> mongo.js suasenha <span class=\"token string\">\"Arto Vihavainen\"</span> 045-1232456</code></pre></div>\n<p>Se a senha for o único parâmetro fornecido ao programa, ou seja, se for chamado assim:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">node</span> mongo.js suasenha</code></pre></div>\n<p>o programa deverá exibir todas as entradas da lista telefônica:</p>\n<pre>\nphonebook:\nAnna 040-1234556\nArto Vihavainen 045-1232456\nAda Lovelace 040-1231236\n</pre>\n<p>É possível obter os parâmetros da linha de comando através da variável <a href=\"https://nodejs.org/docs/latest-v8.x/api/process.html#process_process_argv\">process.argv</a>.</p>\n<p><strong>Obs.: não encerre a conexão no lugar errado</strong>. Por exemplo, o código a seguir não funcionará:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">Person\n  <span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">persons</span><span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\nmongoose<span class=\"token punctuation\">.</span>connection<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>No código acima, o comando <code>mongoose.connection.close()</code> será executado imediatamente após a operação <i>Person.find</i> ser iniciada. Isso significa que a conexão com o banco de dados será fechada imediatamente, e a execução nunca chegará ao ponto em que a operação <i>Person.find</i> termina e a função <i>callback</i> é chamada.</p>\n<p>O local correto para fechar a conexão com o banco de dados é no final da função <i>callback</i>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">Person\n  <span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">persons</span><span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n    mongoose<span class=\"token punctuation\">.</span>connection<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><strong>Obs.:</strong> Se você definir um modelo com o nome <i>Person</i>, o mongoose nomeará automaticamente a coleção associada como <i>people</i>.</p>\n</div>\n<div class=\"content\">\n<h3>Conectando o backend a um banco de dados</h3>\n<p>Agora temos conhecimento suficiente para começar a usar o Mongo em nossa aplicação.</p>\n<p>Vamos rapidamente copiar e colar as definições do Mongoose no arquivo <i>index.js</i>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> mongoose <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'mongoose'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// NÃO SALVE SUA SENHA NO GITHUB!!</span>\n<span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span>\n  <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">mongodb+srv://fullstack:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>password<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">@cluster0.o1opl.mongodb.net/?retryWrites=true&amp;w=majority</span><span class=\"token template-punctuation string\">`</span></span>\n\nmongoose<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'strictQuery'</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\nmongoose<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> noteSchema <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">mongoose<span class=\"token punctuation\">.</span>Schema</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">content</span><span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">important</span><span class=\"token operator\">:</span> Boolean<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> Note <span class=\"token operator\">=</span> mongoose<span class=\"token punctuation\">.</span><span class=\"token function\">model</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Note'</span><span class=\"token punctuation\">,</span> noteSchema<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Vamos mudar o gerenciador para buscar todas as notas da seguinte forma:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  Note<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">notes</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>notes<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Podemos verificar no navegador que o backend funciona na medida em que exibe todos os documentos:</p>\n<picture><img src=\"/static/321bffdcfa60d9fef6fefe5578eb4791/5a190/44ea.png\" alt=\"o endereço &#x27;api/notes&#x27; no navegador mostra as notas em formato JSON\" srcset=\"/static/321bffdcfa60d9fef6fefe5578eb4791/772e8/44ea.png 200w,\n/static/321bffdcfa60d9fef6fefe5578eb4791/e17e5/44ea.png 400w,\n/static/321bffdcfa60d9fef6fefe5578eb4791/5a190/44ea.png 800w,\n/static/321bffdcfa60d9fef6fefe5578eb4791/c1b63/44ea.png 1200w,\n/static/321bffdcfa60d9fef6fefe5578eb4791/29007/44ea.png 1600w,\n/static/321bffdcfa60d9fef6fefe5578eb4791/5eb90/44ea.png 1612w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>A aplicação funciona quase perfeitamente. O frontend assume que cada objeto tem um id único no campo <i>id</i>. Também não queremos retornar o campo de versionamento do Mongo <i>__v</i> para o frontend.</p>\n<p>Uma maneira de formatar os objetos retornados pelo Mongoose é <a href=\"https://stackoverflow.com/questions/7034848/mongodb-output-id-instead-of-id\">modificar</a> o método <em>toJSON</em> do esquema, que é usado em todas as instâncias dos modelos produzidos com esse esquema.</p>\n<p>Para modificar o método, precisamos alterar as opções configuráveis ​​do esquema. As opções podem ser alteradas usando o método <em>set</em> do esquema. Entre aqui para obter mais informações sobre este método: <a href=\"https://mongoosejs.com/docs/guide.html#options\">https://mongoosejs.com/docs/guide.html#options</a>. Veja <a href=\"https://mongoosejs.com/docs/guide.html#toJSON\">https://mongoosejs.com/docs/guide.html#toJSON</a> e <a href=\"https://mongoosejs.com/docs/api.html#document_Document-toObject\">https://mongoosejs.com/docs/api.html#document_Document-toObject</a> para obter mais informações sobre a opção <em>toJSON</em>.</p>\n<p>Entre no link <a href=\"https://mongoosejs.com/docs/api.html#transform\">https://mongoosejs.com/docs/api.html#transform</a> para obter mais informações sobre a função de transformação (transform function).</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">noteSchema<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'toJSON'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">transform</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">document<span class=\"token punctuation\">,</span> returnedObject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    returnedObject<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> returnedObject<span class=\"token punctuation\">.</span>_id<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">delete</span> returnedObject<span class=\"token punctuation\">.</span>_id\n    <span class=\"token keyword\">delete</span> returnedObject<span class=\"token punctuation\">.</span>__v\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Embora a propriedade <i>_id</i> dos objetos Mongoose pareça uma string, na verdade é um objeto. O método <em>toJSON</em> que definimos transforma-o em uma string como garantia. Se não fizéssemos essa mudança, isso nos causaria mais problemas no futuro quando começássemos a escrever testes.</p>\n<p>Nenhuma mudança é necessária no gerenciador:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  Note<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">notes</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>notes<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>O código usa automaticamente o já definido <em>toJSON</em> quando formata as notas para serem enviadas como resposta.</p>\n<h3>A configuração do banco de dados em seu próprio módulo</h3>\n<p>Antes de refatorarmos o restante do backend para usar o banco de dados, vamos extrair o código específico do Mongoose em seu próprio módulo.</p>\n<p>Vamos criar um novo diretório para o módulo chamado <i>models</i>, onde adicionaremos um arquivo chamado <i>note.js</i>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> mongoose <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'mongoose'</span><span class=\"token punctuation\">)</span>\n\nmongoose<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'strictQuery'</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">MONGODB_URI</span></span>\n<span class=\"gatsby-highlight-code-line\">console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'connecting to'</span><span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">)</span></span>\nmongoose<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'connected to MongoDB'</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error connecting to MongoDB:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span>\n<span class=\"token keyword\">const</span> noteSchema <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">mongoose<span class=\"token punctuation\">.</span>Schema</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">content</span><span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">important</span><span class=\"token operator\">:</span> Boolean<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\nnoteSchema<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'toJSON'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">transform</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">document<span class=\"token punctuation\">,</span> returnedObject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    returnedObject<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> returnedObject<span class=\"token punctuation\">.</span>_id<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">delete</span> returnedObject<span class=\"token punctuation\">.</span>_id\n    <span class=\"token keyword\">delete</span> returnedObject<span class=\"token punctuation\">.</span>__v\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"gatsby-highlight-code-line\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> mongoose<span class=\"token punctuation\">.</span><span class=\"token function\">model</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Note'</span><span class=\"token punctuation\">,</span> noteSchema<span class=\"token punctuation\">)</span></span></code></pre></div>\n<p>A definição de <a href=\"https://nodejs.org/docs/latest-v8.x/api/modules.html\">módulos</a> do Node difere um pouco da maneira de definir <a href=\"/ptbr/part2/renderizacao_de_uma_colecao_e_modulos#refatorando-modulos\">módulos ES6</a> da Parte 2.</p>\n<p>A interface pública do módulo é estabelecida ao definir um valor para a variável <em>module.exports</em>. Vamos definir o valor como o modelo <i>Note</i>. As outras coisas definidas dentro do módulo, como as variáveis <em>mongoose</em> e <em>url</em>, não serão acessíveis ou visíveis para os usuários do módulo.</p>\n<p>A importação do módulo acontece adicionando a seguinte linha no arquivo <i>index.js</i>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> Note <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./models/note'</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Dessa forma, a variável <em>Note</em> será atribuída ao mesmo objeto que o módulo define.</p>\n<p>A forma como a conexão é feita mudou um pouco:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">MONGODB_URI</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'connecting to'</span><span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">)</span>\n\nmongoose<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'connected to MongoDB'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error connecting to MongoDB:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Não é uma boa ideia colocar o endereço do banco de dados no código; então, em vez disso, o endereço do banco de dados é passado para a aplicação através da variável de ambiente <em>MONGODB_URI</em>.</p>\n<p>Agora, o método para estabelecer a conexão recebe funções para lidar com uma tentativa de conexão bem-sucedida e mal-sucedida. Ambas as funções registram apenas uma mensagem no console sobre o status de sucesso:</p>\n<picture><img src=\"/static/b7b715296b130693831cc719ea8d2f99/5a190/45e.png\" alt=\"saída do Node quando nome de usuário/senha são incorretos\" srcset=\"/static/b7b715296b130693831cc719ea8d2f99/772e8/45e.png 200w,\n/static/b7b715296b130693831cc719ea8d2f99/e17e5/45e.png 400w,\n/static/b7b715296b130693831cc719ea8d2f99/5a190/45e.png 800w,\n/static/b7b715296b130693831cc719ea8d2f99/c1b63/45e.png 1200w,\n/static/b7b715296b130693831cc719ea8d2f99/35890/45e.png 1582w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Existem muitas maneiras de definir o valor de uma variável de ambiente. Uma maneira seria defini-la quando a aplicação é iniciada:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">MONGODB_URI</span><span class=\"token operator\">=</span>address_here <span class=\"token function\">npm</span> run dev</code></pre></div>\n<p>Uma maneira mais sofisticada é usar a biblioteca <a href=\"https://github.com/motdotla/dotenv#readme\">dotenv</a>. É possível instalá-la com o comando:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> dotenv</code></pre></div>\n<p>Para usar a biblioteca, criamos um arquivo <i>.env</i> na raiz do projeto. As variáveis de ambiente são definidas dentro do arquivo, coisa que se parece assim:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">MONGODB_URI</span><span class=\"token operator\">=</span>mongodb+srv://fullstack:thepasswordishere@cluster0.o1opl.mongodb.net/noteApp?retryWrites<span class=\"token operator\">=</span>true<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">w</span><span class=\"token operator\">=</span>majority\n<span class=\"token assign-left variable\">PORT</span><span class=\"token operator\">=</span><span class=\"token number\">3001</span></code></pre></div>\n<p>Também adicionamos a porta indicada do servidor na variável de ambiente <em>PORT</em>.</p>\n<p><strong>O arquivo <i>.env</i> deve ser ignorado (adicionado ao arquivo .gitignore) imediatamente, pois não queremos publicar informações confidenciais na internet!</strong></p>\n<picture><img src=\"/static/e12482f21c1bd50aaa9fa2e9a85169f1/5a190/45ae.png\" alt=\".gitignore no vscode com a linha .env adicionada\" srcset=\"/static/e12482f21c1bd50aaa9fa2e9a85169f1/772e8/45ae.png 200w,\n/static/e12482f21c1bd50aaa9fa2e9a85169f1/e17e5/45ae.png 400w,\n/static/e12482f21c1bd50aaa9fa2e9a85169f1/5a190/45ae.png 800w,\n/static/e12482f21c1bd50aaa9fa2e9a85169f1/c1b63/45ae.png 1200w,\n/static/e12482f21c1bd50aaa9fa2e9a85169f1/f2f8c/45ae.png 1490w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>As variáveis de ambiente definidas no arquivo <i>.env</i> podem ser utilizadas com a expressão <em>require('dotenv').config()</em>, onde é possível se referir a elas em seu código da mesma maneira que você se refere a variáveis de ambiente normais, com a já familiar sintaxe <em>process.env.MONGODB_URI</em>.</p>\n<p>Vamos mudar o arquivo <i>index.js</i> da seguinte maneira:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"gatsby-highlight-code-line\"><span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dotenv'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"token keyword\">const</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> Note <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./models/note'</span><span class=\"token punctuation\">)</span></span>\n<span class=\"token comment\">// ..</span>\n\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> <span class=\"token constant\">PORT</span> <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">PORT</span></span>app<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PORT</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Server running on port (Servidor em execução na porta) </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">PORT</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>É importante que o <i>dotenv</i> seja importado antes do modelo <i>note</i>. Isso garante que as variáveis de ambiente do arquivo <i>.env</i> estejam disponíveis globalmente antes que o código dos outros módulos seja importado.</p>\n<h3>Nota importante para usuários do Fly.io</h3>\n<p>Como o GitHub não é usado com Fly.io, o arquivo .env também é enviado para os servidores Fly.io quando a aplicação é implantada. Por causa disso, as variáveis de ambiente definidas no arquivo também estarão disponíveis lá.</p>\n<p>No entanto, uma <a href=\"https://community.fly.io/t/clarification-on-environment-variables/6309\">opção melhor</a> é impedir que .env seja copiado ao Fly.io criando, na raiz do projeto, o arquivo <em>.dockerignore</em> com o seguinte conteúdo:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">.env</code></pre></div>\n<p>Defina o valor da variável de ambiente na linha de comando desta forma:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">fly secrets set MONGODB_URI='mongodb+srv://fullstack:thepasswordishere@cluster0.o1opl.mongodb.net/noteApp?retryWrites=true&amp;w=majority'</code></pre></div>\n<p>Já que a variável PORT também é definida em nosso .env, é essencial ignorar o arquivo no Fly.io, caso contrário, a aplicação iniciará na porta errada.</p>\n<p>Ao usar o Render, a url do banco de dados é fornecida definindo a variável de ambiente adequada no painel:</p>\n<picture><img src=\"/static/ae7c73092becbbef8aa45299e9b8fbcd/5a190/render-env.png\" alt=\"navegador mostrando as variáveis de ambiente\" srcset=\"/static/ae7c73092becbbef8aa45299e9b8fbcd/772e8/render-env.png 200w,\n/static/ae7c73092becbbef8aa45299e9b8fbcd/e17e5/render-env.png 400w,\n/static/ae7c73092becbbef8aa45299e9b8fbcd/5a190/render-env.png 800w,\n/static/ae7c73092becbbef8aa45299e9b8fbcd/c1b63/render-env.png 1200w,\n/static/ae7c73092becbbef8aa45299e9b8fbcd/29007/render-env.png 1600w,\n/static/ae7c73092becbbef8aa45299e9b8fbcd/97a96/render-env.png 2400w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<h3>Usando o banco de dados em gerenciadores de evento de rotas</h3>\n<p>Agora, vamos mudar o resto da funcionalidade do backend para usar o banco de dados.</p>\n<p>Cria-se uma nova nota desta forma:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> body <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>body\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">.</span>content <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">error</span><span class=\"token operator\">:</span> <span class=\"token string\">'content missing'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> note <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Note</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">content</span><span class=\"token operator\">:</span> body<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">important</span><span class=\"token operator\">:</span> body<span class=\"token punctuation\">.</span>important <span class=\"token operator\">||</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  note<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">savedNote</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>savedNote<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Os objetos de <i>note</i> são criados com a função construtora <em>Note</em>. A resposta é enviada dentro da função callback para a operação <em>save</em>. Isso garante que a resposta seja enviada somente se a operação tiver sucesso. Discutiremos sobre gerenciamento de erros um pouco mais tarde.</p>\n<p>O parâmetro <em>savedNote</em> na função callback é a nota salva e recém-criada. Os dados enviados de volta na resposta são a versão formatada criada automaticamente com o método <em>toJSON</em>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>savedNote<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Busca-se uma nota individual utilizando o método <a href=\"https://mongoosejs.com/docs/api/model.html#model_Model-findById\">findById</a> (grosso modo, \"acharPorId\") do Mongoose, onde nosso código altera-se da seguinte forma:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  Note<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">note</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3>Verificando a integração entre frontend e backend</h3>\n<p>Ao se expandir o backend, sempre é uma boa ideia testá-lo primeiro <strong>com o navegador, com o Postman ou com o cliente REST do VS Code</strong>. Em seguida, vamos tentar criar uma nova nota depois colocar o banco de dados em uso:</p>\n<picture><img src=\"/static/b0e29107aaf7510cebfd5fe29518fc92/5a190/46new.png\" alt=\"Cliente REST do VS Code utilizando o método POST\" srcset=\"/static/b0e29107aaf7510cebfd5fe29518fc92/772e8/46new.png 200w,\n/static/b0e29107aaf7510cebfd5fe29518fc92/e17e5/46new.png 400w,\n/static/b0e29107aaf7510cebfd5fe29518fc92/5a190/46new.png 800w,\n/static/b0e29107aaf7510cebfd5fe29518fc92/c1b63/46new.png 1200w,\n/static/b0e29107aaf7510cebfd5fe29518fc92/29007/46new.png 1600w,\n/static/b0e29107aaf7510cebfd5fe29518fc92/720e3/46new.png 1962w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Somente depois de verificar se tudo funciona no backend, é uma boa ideia testar se o frontend funciona com o backend. É extremamente ineficiente testar as funcionalidades exclusivamente pelo frontend.</p>\n<p>Sempre é uma boa ideia integrar tanto ao frontend quanto ao backend uma funcionalidade de cada vez. Primeiro, poderíamos implementar a busca de todas as notas no banco de dados e testá-la por meio do <i>endpoint</i> do backend no navegador. Após, verificaríamos se o frontend funciona com o novo backend. Depois que tudo parecer estar funcionando, passaríamos para a próxima funcionalidade.\n<i><em>Nota dos tradutores</em>: objetivamente, dentro do conceito de API, um <i>endpoint</i> é o endereço URL que identifica e acessa um recurso específico. Leia mais <a href=\"https://www.cloudflare.com/pt-br/learning/security/api/what-is-api-endpoint/\">aqui</a>.</i></p>\n<p>Uma vez que um banco de dados é introduzido nessa mistura, é sempre útil inspecionar o estado persistido no banco de dados através, por exemplo, do painel de controle do MongoDB Atlas. Muitas vezes, pequenos programas auxiliares do Node como o <i>mongo.js</i> que escrevemos anteriormente podem ser muito úteis durante o desenvolvimento.</p>\n<p>Você pode encontrar o código da nossa aplicação atual na íntegra na branch <i>part3-4</i> deste repositório do <a href=\"https://github.com/fullstack-hy2020/part3-notes-backend/tree/part3-4\">GitHub</a>.</p>\n</div>\n<div class=\"tasks\">\n<h3>Exercícios 3.13 a 3.14</h3>\n<p>Os próximos exercícios são bem simples, mas se o seu frontend parar de funcionar com o backend, pode ser até bastante interessante encontrar e corrigir os bugs que forem surgindo.</p>\n<h4>3.13: Phonebook database — 1º passo</h4>\n<p>Altere a funcionalidade que busca todas as entradas da lista telefônica para que os dados sejam <i>buscados do banco de dados</i>.</p>\n<p>Verifique se o frontend funciona depois que as alterações forem feitas.</p>\n<p>Nos próximos exercícios, escreva todo o código específico do Mongoose em seu próprio módulo, assim como fizemos no capítulo <a href=\"/ptbr/part3/salvando_dados_no_mongo_db#a-configuracao-do-banco-de-dados-em-seu-proprio-modulo\">\"A configuração do banco de dados em seu próprio módulo\"</a>.</p>\n<h4>3.14: Phonebook database — 2º passo</h4>\n<p>Altere o backend para que os novos números sejam <i>salvos no banco de dados</i>. Verifique se o seu frontend ainda funciona após as alterações.</p>\n<p>Você pode ignorar, nesta etapa, se já existe uma pessoa no banco de dados com o mesmo nome da pessoa que você está adicionando.</p>\n</div>\n<div class=\"content\">\n<h3>Gerenciamento de erros</h3>\n<p>Se tentarmos visitar a URL de uma nota com um ID que não existe, por exemplo <a href=\"http://localhost:3001/api/notes/5c41c90e84d891c15dfa3431\">http://localhost:3001/api/notes/5c41c90e84d891c15dfa3431</a>, onde <i>5c41c90e84d891c15dfa3431</i> não é um ID armazenado no banco de dados, a resposta será <em>null</em>.</p>\n<p>Vamos mudar esse comportamento para que, se uma nota com o ID fornecido não existir, o servidor responda à requisição com o código de status HTTP \"404 not found\" (404 não encontrado(a)). Além disso, vamos implementar um simples bloco <em>catch</em> para lidar com casos em que a promessa retornada pelo método <em>findById</em> é <i>rejeitada</i>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  Note<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">note</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">        response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">        response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">404</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token punctuation\">}</span></span>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">      response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Se nenhum objeto correspondente for encontrado no banco de dados, o valor de <em>note</em> será <em>null</em> e o bloco <em>else</em> será executado. Isso resulta em uma resposta com o código de status <i>404 not found</i> (404 não encontrado(a)). Se uma promessa retornada pelo método <em>findById</em> for rejeitada, a resposta terá o código de status <i>500 internal server error</i> (500 erro interno do servidor). O console exibe informações mais detalhadas sobre o erro.</p>\n<p>Além da nota inexistente, há mais uma situação de erro que precisa ser lidada. Nessa situação, estamos tentando buscar uma nota com o tipo errado de <em>id</em>, ou seja, um <em>id</em> que não corresponde ao formato de identificador do Mongo.</p>\n<p>Se fizermos a seguinte requisição, obteremos a mensagem de erro mostrada abaixo:</p>\n<pre>\nMethod: GET\nPath:   /api/notes/someInvalidId\nBody:   {}\n---\n{ CastError: Cast to ObjectId failed for value \"someInvalidId\" at path \"_id\"\n    at CastError (/Users/mluukkai/opetus/_fullstack/osa3-muisiinpanot/node_modules/mongoose/lib/error/cast.js:27:11)\n    at ObjectId.cast (/Users/mluukkai/opetus/_fullstack/osa3-muisiinpanot/node_modules/mongoose/lib/schema/objectid.js:158:13)\n    ...\n</pre>\n<p>Dado um ID mal formatado como argumento, o método <em>findById</em> lançará um erro, fazendo com que a promessa retornada seja rejeitada. Isso fará com que a função callback definida no bloco <em>catch</em> seja chamada.</p>\n<p>Vamos fazer alguns pequenos ajustes de resposta no bloco <em>catch</em>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  Note<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">note</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">404</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> \n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">      response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">error</span><span class=\"token operator\">:</span> <span class=\"token string\">'malformatted id'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Se o formato do ID estiver incorreto, o gerenciador de erro definido no bloco <em>catch</em> será chamado. O código de status apropriado para o erro é <a href=\"https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1\">400 Bad Request</a> (<i>400 requisição inválida</i>), porque a situação se encaixa perfeitamente na descrição:</p>\n<blockquote>\n<p><i>A requisição não pôde ser entendida pelo servidor devido a uma sintaxe mal formatada. O cliente NÃO DEVE repetir a requisição sem modificações.</i></p>\n</blockquote>\n<p>Também adicionamos alguns dados à resposta para esclarecer a causa do erro.</p>\n<p>Ao lidar com Promessas, quase sempre é uma boa ideia adicionar gerenciamento de erro e exceção. Caso contrário, você se encontrará lidando com bugs estranhos.</p>\n<p>Nunca é uma má ideia imprimir o objeto que causou a exceção no console do gerenciador de erro:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span></span>  response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">error</span><span class=\"token operator\">:</span> <span class=\"token string\">'malformatted id'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>A razão pela qual o gerenciador de erro é chamado pode ser algo completamente diferente do que você havia imaginado. Se você imprimir o erro no console, poderá se salvar de longas e frustrantes sessões de depuração. Além disso, a maioria dos serviços modernos onde você implanta sua aplicação suporta algum tipo de sistema de registro (logging system) que se pode usar para verificar esses logs. Como já mencionado, o Heroku é um deles.</p>\n<p>Toda vez que você trabalha em um projeto com um backend, <i>é crucial ficar de olho na saída do console do backend</i>. Se você está usando uma tela pequena, já é suficiente ver apenas um pedacinho da tela de saída em segundo plano. Qualquer mensagem de erro chamará sua atenção mesmo quando o console estiver bem escondido:</p>\n<picture><img src=\"/static/b5656dca7416a1a37670dc5a51bfbbc7/5a190/15b.png\" alt=\"amostra de captura de tela mostrando um pedacinho da tela de saída\" srcset=\"/static/b5656dca7416a1a37670dc5a51bfbbc7/772e8/15b.png 200w,\n/static/b5656dca7416a1a37670dc5a51bfbbc7/e17e5/15b.png 400w,\n/static/b5656dca7416a1a37670dc5a51bfbbc7/5a190/15b.png 800w,\n/static/b5656dca7416a1a37670dc5a51bfbbc7/c1b63/15b.png 1200w,\n/static/b5656dca7416a1a37670dc5a51bfbbc7/29007/15b.png 1600w,\n/static/b5656dca7416a1a37670dc5a51bfbbc7/966ce/15b.png 2050w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<h3>Transferindo o gerenciamento de erro para um middleware</h3>\n<p>Escrevemos o código do gerenciador de erro junto ao restante do código. Pode até ser uma solução razoável às vezes, mas há casos em que é melhor implementar todo o gerenciamento de erro em um único lugar. Isso pode ser particularmente útil se quisermos relatar dados relacionados a erros para um sistema externo de rastreamento de erros (external error-tracking system) como o <a href=\"https://sentry.io/welcome/\">Sentry</a> posteriormente.</p>\n<p>Vamos mudar o gerenciador para a rota <i>/api/notes/:id</i> para que ele passe o erro adiante com a função <em>next</em>. A função <em>next</em> é passada para o gerenciador como o terceiro parâmetro:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"gatsby-highlight-code-line\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span>  Note<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">note</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">404</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>O erro que é passado adiante é devido à função <em>next</em> como parâmetro. Se <em>next</em> for chamada sem um parâmetro, então a execução simplesmente avançará para a próxima rota ou middleware. Se a função <em>next</em> for chamada com um parâmetro, então a execução continuará para o <i>middleware de gerenciamento de erro</i>.</p>\n<p>Os <a href=\"https://expressjs.com/en/guide/error-handling.html\">gerenciadores de erro</a> do Express são middlewares definidos com uma função que aceita <i>quatro parâmetros</i>. Nosso gerenciador de erro é assim:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">errorHandler</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">error<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>name <span class=\"token operator\">===</span> <span class=\"token string\">'CastError'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">error</span><span class=\"token operator\">:</span> <span class=\"token string\">'malformatted id'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> \n\n  <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Este deve ser o último middleware a ser carregado.</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>errorHandler<span class=\"token punctuation\">)</span></code></pre></div>\n<p>O gerenciador de erro verifica se o erro é uma exceção <i>CastError</i> (grosso modo, \"ErroDeLançamento\"), caso em que sabemos que o erro foi causado por um id de objeto inválido para o Mongo. Nessa situação, o gerenciador de erro enviará uma resposta ao navegador com o objeto de resposta passado como parâmetro. Em todas as outras situações de erro, o middleware passa o erro para o gerenciador de erro padrão do Express.</p>\n<p>Observe que o middleware de gerenciamento de erro deve ser o último middleware a ser carregado!</p>\n<h3>A ordem de carregamento dos middlewares</h3>\n<p>A ordem de execução dos middlewares é a mesma que a ordem em que são carregados no Express com a função <em>app.use</em>. Por esse motivo, é importante ter cuidado ao definir os middlewares.</p>\n<p>A ordem correta é a seguinte:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>express<span class=\"token punctuation\">.</span><span class=\"token function\">static</span><span class=\"token punctuation\">(</span><span class=\"token string\">'build'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>express<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>requestLogger<span class=\"token punctuation\">)</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> body <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>body\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">unknownEndpoint</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">404</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">error</span><span class=\"token operator\">:</span> <span class=\"token string\">'unknown endpoint'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// gerenciador de requisições com um endpoint desconhecido</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>unknownEndpoint<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">errorHandler</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">error<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// gerenciador de requisições com um resultado para erros</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>errorHandler<span class=\"token punctuation\">)</span></code></pre></div>\n<p>O middleware JSON-parser (\"analisador de JSON\") deve estar entre os primeiros middlewares carregados no Express. Se a ordem fosse a seguinte...</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>requestLogger<span class=\"token punctuation\">)</span> <span class=\"token comment\">// request.body torna-se indefinido!</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// request.body torna-se indefinido!</span>\n  <span class=\"token keyword\">const</span> body <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>body\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>express<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>... os dados JSON enviados com as requisições HTTP não estariam disponíveis para o middleware de registro (logger middleware) ou para o gerenciador da rota POST, já que o <em>request.body</em> estaria <em>indefinido</em> nesse ponto.</p>\n<p>Também é importante que o middleware que gerencia rotas não suportadas esteja próximo ao último middleware que é carregado no Express, logo antes do gerenciador de erro.</p>\n<p>Por exemplo, a seguinte ordem de carregamento causaria um problema:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">unknownEndpoint</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">404</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">error</span><span class=\"token operator\">:</span> <span class=\"token string\">'unknown endpoint'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// gerenciador de requisições com endpoint desconhecido</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>unknownEndpoint<span class=\"token punctuation\">)</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Dessa forma, o gerenciamento de endpoints desconhecidos é posto em ordem <i>antes do gerenciador de requisições HTTP</i>. Como o gerenciador de endpoints desconhecidos responde a todas as requisições com <i>404 unknown endpoint</i> (404 endpoint desconhecido), nenhuma rota ou middleware será chamado após a resposta ter sido enviada pelo middleware de endpoint desconhecido. A única exceção a isso é o gerenciador de erros, que precisa vir no final, após o gerenciador de endpoints desconhecidos.</p>\n<h3>Outras operações</h3>\n<p>Vamos adicionar algumas funcionalidades restantes à nossa aplicação, incluindo a exclusão e a atualização de uma nota individual.</p>\n<p>A maneira mais fácil de excluir uma nota do banco de dados é com o método <a href=\"https://mongoosejs.com/docs/api/model.html#model_Model-findByIdAndDelete\">findByIdAndDelete</a> (grosso modo, \"acharPorIdERemover\"):</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  Note<span class=\"token punctuation\">.</span><span class=\"token function\">findByIdAndDelete</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">204</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Em ambos os casos \"bem-sucedidos\" de exclusão de um recurso, o backend responde com o código de status <i>204 no content</i> (204 sem conteúdo). Os dois casos diferentes são: (1) excluir uma nota que existe; e (2) excluir uma nota que não existe no banco de dados. O parâmetro de retorno <em>result</em> poderia ser usado para verificar se um recurso foi realmente excluído, e poderíamos usar essa informação para retornar diferentes códigos de status para os dois casos, caso julgássemos necessário. Qualquer exceção que venha a ocorrer é lançada ao gerenciador de erro.</p>\n<p>A alternância da importância de uma nota pode ser facilmente realizada com o método <a href=\"https://mongoosejs.com/docs/api/model.html#model_Model-findByIdAndUpdate\">findByIdAndUpdate</a> (grosso modo, \"acharPorIdEAtualizar\").</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> body <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>body\n\n  <span class=\"token keyword\">const</span> note <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">content</span><span class=\"token operator\">:</span> body<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">important</span><span class=\"token operator\">:</span> body<span class=\"token punctuation\">.</span>important<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n\n  Note<span class=\"token punctuation\">.</span><span class=\"token function\">findByIdAndUpdate</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> note<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">new</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">updatedNote</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>updatedNote<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>No código acima, também permitimos a edição do conteúdo da nota.</p>\n<p>Observe que o método <em>findByIdAndUpdate</em> recebe um objeto JavaScript comum como parâmetro, e não um novo objeto de nota criado com a função construtora <em>Note</em>.</p>\n<p>Existe um detalhe importante em relação ao uso do método <em>findByIdAndUpdate</em>. Por padrão, o parâmetro <em>updatedNote</em> do gerenciador de evento recebe o documento original <a href=\"https://mongoosejs.com/docs/api/model.html#model_Model-findByIdAndUpdate\">sem as modificações</a>. Adicionamos o parâmetro opcional <code>{ new: true }</code>, que fará com que nosso gerenciador de evento seja chamado com o novo documento modificado em vez do original.</p>\n<p>Após testar o backend diretamente com o Postman e o cliente REST do VS Code, podemos verificar que parece funcionar. O frontend também parece funcionar com o backend usando o banco de dados.</p>\n<p>É possível encontrar o código da nossa aplicação atual na íntegra na branch <i>part3-5</i> <a href=\"https://github.com/fullstack-hy2020/part3-notes-backend/tree/part3-5\">neste repositório do GitHub</a>.</p>\n<h3>Juramento de um Verdadeiro Programador Full Stack</h3>\n<p>Chegou novamente a hora dos exercícios. A complexidade de nossa aplicação cresceu pois, além do frontend e do backend, também temos um banco de dados. Há de fato muitas fontes potenciais de erros.</p>\n<p>Portanto, devemos estender novamente nosso juramento:</p>\n<p>Desenvolvimento Full Stack é algo <i>extremamente difícil</i>, e é por isso que eu usarei todos os meios possíveis para torná-lo mais fácil:</p>\n<ul>\n<li>Eu manterei meu Console do navegador sempre aberto;</li>\n<li>Eu usarei a guia Rede das Ferramentas do Desenvolvedor do navegador para garantir que o frontend e o backend estejam se comunicando da forma que eu planejei;</li>\n<li>Eu ficarei de olho no estado do servidor para garantir que os dados enviados pelo frontend estejam sendo salvos lá da forma que eu planejei;</li>\n<li><i>Eu ficarei de olho no banco de dados: o backend salva os dados no banco de dados no formato correto?</i> ;</li>\n<li>Eu vou progredir aos poucos, passo a passo;</li>\n<li>Eu escreverei muitas instruções <em>console.log</em> para ter certeza de que estou entendendo como o código se comporta e para me ajudar a identificar os erros;</li>\n<li>Se meu código não funcionar, não escreverei mais nenhuma linha no código. Em vez disso, começarei a excluir o código até que funcione ou retornarei ao estado em que tudo ainda estava funcionando; e</li>\n<li>Quando eu pedir ajuda no canal do Discord ou Telegram do curso ou em outro lugar, formularei minhas perguntas de forma adequada. Veja <a href=\"/ptbr/part0/informacoes_gerais#como-pedir-ajuda-no-discord-telegam\">aqui</a> como pedir ajuda.</li>\n</ul>\n</div>\n<div class=\"tasks\">\n<h3>Exercícios 3.15 a 3.18</h3>\n<h4>3.15: Phonebook database — 3º passo</h4>\n<p>Altere o backend para que a exclusão de entradas da lista telefônica seja refletida no banco de dados.</p>\n<p>Verifique se o frontend ainda funciona após as alterações.</p>\n<h4>3.16: Phonebook database — 4º passo</h4>\n<p>Transfira o gerenciamento de erros da aplicação para um novo middleware gerenciador de erros.</p>\n<h4>3.17*: Phonebook database — 5º passo</h4>\n<p>Se o usuário tentar criar uma nova entrada na lista telefônica para uma pessoa cujo nome já está presente na lista, o frontend tentará atualizar o número de telefone da entrada existente fazendo uma requisição HTTP PUT para a URL única da entrada.</p>\n<p>Modifique o backend para suportar essa requisição.</p>\n<p>Verifique se o frontend funciona após fazer suas alterações.</p>\n<h4>3.18*: Phonebook database — 6º passo</h4>\n<p>Atualize também o gerenciamento das rotas <i>api/persons/:id</i> e <i>info</i> para usar o banco de dados e verifique se elas funcionam diretamente com o navegador, com o Postman ou com o cliente REST do VS Code.</p>\n<p>A verificação no navegador de uma entrada individual da lista telefônica deve ocorrer da seguinte maneira:</p>\n<picture><img src=\"/static/853a1d57372a2b5c8fc1249b682d59a7/5a190/49.png\" alt=\"captura de tela do navegador mostrando uma pessoa utilizando a rota &#x27;api/persons/their_id&#x27;\" srcset=\"/static/853a1d57372a2b5c8fc1249b682d59a7/772e8/49.png 200w,\n/static/853a1d57372a2b5c8fc1249b682d59a7/e17e5/49.png 400w,\n/static/853a1d57372a2b5c8fc1249b682d59a7/5a190/49.png 800w,\n/static/853a1d57372a2b5c8fc1249b682d59a7/c1b63/49.png 1200w,\n/static/853a1d57372a2b5c8fc1249b682d59a7/c655d/49.png 1586w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n</div>","frontmatter":{"mainImage":{"publicURL":"/static/8ac7bc0fb2b7018a7853b00c454b2103/part-3.svg"},"part":3,"letter":"c","lang":"ptbr"}}},"pageContext":{"part":3,"letter":"c","lang":"ptbr"}},"staticQueryHashes":["3128451518"]}
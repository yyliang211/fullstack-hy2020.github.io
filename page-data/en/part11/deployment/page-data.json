{"componentChunkName":"component---src-templates-content-template-js","path":"/en/part11/deployment","result":{"data":{"markdownRemark":{"html":"<div class=\"content\">\n<p>Having written a nice application it's time to think about how we're going to deploy it to the use of real users. </p>\n<p>In <a href=\"/en/part3/deploying_app_to_internet\">part 3</a> of this course, we did this by simply running a single command from terminal to get the code up and running the servers of the cloud provider <a href=\"https://fly.io/\">Fly.io</a> or <a href=\"https://render.com/\">Render</a>.</p>\n<p>It is pretty simple to release software in Fly.io and Render at least compared to many other types of hosting setups but it still contains risks: nothing prevents us from accidentally releasing broken code to production.</p>\n<p>Next, we're going to look at the principles of making a deployment safely and some of the principles of deploying software on both a small and large scale. </p>\n<h3>Anything that can go wrong...</h3>\n<p>We'd like to define some rules about how our deployment process should work but before that, we have to look at some constraints of reality.</p>\n<p>One on the phrasing of Murphy's Law holds that:\n\"Anything that can go wrong will go wrong.\"</p>\n<p>It's important to remember this when we plan out our deployment system. Some of the things we'll need to consider could include:</p>\n<ul>\n<li>What if my computer crashes or hangs during deployment?</li>\n<li>I'm connected to the server and deploying over the internet, what happens if my internet connection dies?</li>\n<li>What happens if any specific instruction in my deployment script/system fails?</li>\n<li>What happens if, for whatever reason, my software doesn't work as expected on the server I'm deploying to? Can I roll back to a previous version?</li>\n<li>What happens if a user does an HTTP request to our software just before we do deployment (we didn't have time to send a response to the user)?</li>\n</ul>\n<p>These are just a small selection of what can go wrong during a deployment, or rather, things that we should plan for. Regardless of what happens, our deployment system should <strong>never</strong> leave our software in a broken state. We should also always know (or be easily able to find out) what state a deployment is in.</p>\n<p>Another important rule to remember when it comes to deployments (and CI in general) is:\n\"Silent failures are <strong>very</strong> bad!\"</p>\n<p>This doesn't mean that failures need to be shown to the users of the software, it means we need to be aware if anything goes wrong. If we are aware of a problem, we can fix it. If the deployment system doesn't give any errors but fails, we may end up in a state where we believe we have fixed a critical bug but the deployment failed, leaving the bug in our production environment and us unaware of the situation.</p>\n<h3>What does a good deployment system do?</h3>\n<p>Defining definitive rules or requirements for a deployment system is difficult, let's try anyway:</p>\n<ul>\n<li>Our deployment system should be able to fail gracefully at <strong>any</strong> step of the deployment.</li>\n<li>Our deployment system should <strong>never</strong> leave our software in a broken state.</li>\n<li>Our deployment system should let us know when a failure has happened. It's more important to notify about failure than about success.</li>\n<li>\n<p>Our deployment system should allow us to roll back to a previous deployment</p>\n<ul>\n<li>Preferably this rollback should be easier to do and less prone to failure than a full deployment</li>\n<li>Of course, the best option would be an automatic rollback in case of deployment failures</li>\n</ul>\n</li>\n<li>Our deployment system should handle the situation where a user makes an HTTP request just before/during a deployment.</li>\n<li>Our deployment system should make sure that the software we are deploying meets the requirements we have set for this (e.g. don't deploy if tests haven't been run).</li>\n</ul>\n<p>Let's define some things we <strong>want</strong> in this hypothetical deployment system too:</p>\n<ul>\n<li>We would like it to be fast</li>\n<li>We'd like to have no downtime during the deployment (this is distinct from the requirement we have for handling user requests just before/during the deployment).</li>\n</ul>\n<p>Next we will have three sets of exercises for automazing the deployment with GitHub Actions, one for <a href=\"https://fly.io/\">Fly.io</a>, another one for <a href=\"https://render.com/\">Render</a>. The process of deployment is always specific to the particular cloud provider, so you can also do both the exercise sets if you want to see the differences how these services work with respect to deployments.</p>\n<h3>Has the app been deployed?</h3>\n<p>Since we are not making any real changes to the app, it might be a bit hard to see if the app deployment really works.\nLet us create a dummy endpoint in the app that makes it possible to do some code changes and to ensure that the deployed version has really changed:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/version'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">'1'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// change this string to ensure a new version deployed</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n</div>\n<div class=\"tasks\">\n<h3>Exercises 11.10-11.12. (Fly.io)</h3>\n<p>If you rather want to use other hosting options, there is an alternative set of exercises for <a href=\"/en/part11/deployment#exercises-11-10-11-12-render\">Render</a>.</p>\n<h4>11.10 Deploying your application to Fly.io</h4>\n<p>Setup your application in <a href=\"https://fly.io/\">Fly.io</a> hosting service like the one we did in <a href=\"/en/part3/deploying_app_to_internet#application-to-the-internet\">part 3</a>.</p>\n<p>In contrast to part 3, in this part we <i>do not deploy the code</i> to Fly.io ourselves (with the command <i>flyctl deploy</i>), we let the GitHub Actions workflow do that for us. </p>\n<p>Before going to the automated deployment, we shall ensure in this exercise that the app can be deployed manually.</p>\n<p>So, create a new app in Fly.io. After that generate a Fly.io API token with the command</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">flyctl auth token</code></pre></div>\n<p>You'll need the token soon for your deployment workflow so save it somewhere (but do not commit that to GitHub)!</p>\n<p>As said, before setting up the deployment pipeline in the next exercise we will now ensure that a manual deployment with the command <i>flyctl deploy</i> works.</p>\n<p>A couple of changes are needed.</p>\n<p>The configuration file <i>fly.toml</i> should be modified to include the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token punctuation\">[</span>env<span class=\"token punctuation\">]</span>\n  PORT = \"3000\" <span class=\"token comment\"># add this where PORT matches the internal_port below</span>\n\n<span class=\"token punctuation\">[</span>processes<span class=\"token punctuation\">]</span>\n  app = \"node app.js\" <span class=\"token comment\"># add this</span>\n\n<span class=\"token punctuation\">[</span>http_service<span class=\"token punctuation\">]</span>\n  internal_port = 3000\n  force_https = true\n  auto_stop_machines = true\n  auto_start_machines = true\n  min_machines_running = 0\n  processes = <span class=\"token punctuation\">[</span><span class=\"token string\">\"app\"</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>In <a href=\"https://fly.io/docs/reference/configuration/#the-processes-section\">processes</a> we define the command that starts the application. Without this change Fly.io just starts the React dev server and that causes it to shut down since the app itself does not start up. We will also set up the PORT to be passed to the app as an environment variable.</p>\n<p>We also need to alter the file <em>.dockerignore</em> a bit, the next line should be removed:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">dist</code></pre></div>\n<p>If the line is not removed, the product build of the frontend does not get downloaded to the Fly.io server.</p>\n<p>Deployment should now work <em>if</em> the production build exists in the local machine, that is, the command <em>npm build</em> is run.</p>\n<p>Before moving to the next exercise, make sure that the manual deployment with the command <i>flyctl deploy</i> works!</p>\n<h4>11.11 Automatic deployments</h4>\n<p>Extend the workflow with a step to deploy your application to Fly.io by following the advice given <a href=\"https://fly.io/docs/app-guides/continuous-deployment-with-github-actions/\">here</a>.</p>\n<p>Note that the GitHub Action should create the production build (with <em>npm run build</em>) before the deployment step!</p>\n<p>You need the authorization token that you just created for the deployment. The proper way to pass it's value to GitHub Actions is to use <em>Repository secrets</em>:</p>\n<picture><img src=\"/static/262b16a3d79127a992d5ae1569da56e2/5a190/10f.png\" alt=\"repo secret\" srcset=\"/static/262b16a3d79127a992d5ae1569da56e2/772e8/10f.png 200w,\n/static/262b16a3d79127a992d5ae1569da56e2/e17e5/10f.png 400w,\n/static/262b16a3d79127a992d5ae1569da56e2/5a190/10f.png 800w,\n/static/262b16a3d79127a992d5ae1569da56e2/c1b63/10f.png 1200w,\n/static/262b16a3d79127a992d5ae1569da56e2/29007/10f.png 1600w,\n/static/262b16a3d79127a992d5ae1569da56e2/f0293/10f.png 2250w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Now the workflow can access the token value as follows:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">${{secrets.FLY_API_TOKEN}}</code></pre></div>\n<p>If all goes well, your workflow log should look a bit like this:</p>\n<picture><img src=\"/static/2816939654aedafdfe882f76c946d33b/5a190/fly-good.png\" srcset=\"/static/2816939654aedafdfe882f76c946d33b/772e8/fly-good.png 200w,\n/static/2816939654aedafdfe882f76c946d33b/e17e5/fly-good.png 400w,\n/static/2816939654aedafdfe882f76c946d33b/5a190/fly-good.png 800w,\n/static/2816939654aedafdfe882f76c946d33b/c1b63/fly-good.png 1200w,\n/static/2816939654aedafdfe882f76c946d33b/29007/fly-good.png 1600w,\n/static/2816939654aedafdfe882f76c946d33b/d698c/fly-good.png 1846w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p><strong>Remember</strong> that it is always essential to keep an eye on what is happening in server logs when playing around with product deployments, so use <code>flyctl logs</code> early and use it often. No, use it all the time!</p>\n<h4>11.12 Health check</h4>\n<p>Each deployment in Fly.io creates a <a href=\"https://fly.io/docs/flyctl/releases/\">release</a>. Releases can be checked from the command line:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ flyctl releases\nVERSION\tSTATUS  \tDESCRIPTION\t<span class=\"token environment constant\">USER</span>           \tDATE\nv18    \tcomplete\tRelease    \tmluukkai@iki.fi\t16h56m ago\nv17    \tcomplete\tRelease    \tmluukkai@iki.fi\t17h3m ago\nv16    \tcomplete\tRelease    \tmluukkai@iki.fi\t21h22m ago\nv15    \tcomplete\tRelease    \tmluukkai@iki.fi\t21h25m ago\nv14    \tcomplete\tRelease    \tmluukkai@iki.fi\t21h34m ago</code></pre></div>\n<p>It is essential to ensure that a deployment ends up in a <i>succeeding</i> release, where the app is in healthy functional state. Fortunately, Fly.io has several configuration options that take care of the application health check.</p>\n<p>If we change the app as follows, it fails to start:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PORT</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  this_causes_error\n  <span class=\"token comment\">// eslint-disable-next-line no-console</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">server started on port </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">PORT</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>In this case, the deployment fails:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ flyctl releases\nVERSION\tSTATUS  \tDESCRIPTION\t<span class=\"token environment constant\">USER</span>           \tDATE\nv19    \tfailed  \tRelease    \tmluukkai@iki.fi\t3m52s ago\nv18    \tcomplete\tRelease    \tmluukkai@iki.fi\t16h56m ago\nv17    \tcomplete\tRelease    \tmluukkai@iki.fi\t17h3m ago\nv16    \tcomplete\tRelease    \tmluukkai@iki.fi\t21h22m ago\nv15    \tcomplete\tRelease    \tmluukkai@iki.fi\t21h25m ago\nv14    \tcomplete\tRelease    \tmluukkai@iki.fi\t21h34m ago</code></pre></div>\n<p>The app however stays up and running, Fly.io does not replace the functioning version  (v18) with the broken one (v19).</p>\n<p>Let us consider the following change</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// start app in a wrong port</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PORT</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// eslint-disable-next-line no-console</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">server started on port </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">PORT</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Now the app starts but it is connected to the wrong port, so the service will not be functional. Fly.io thinks this is a successful deployment, so it deploys the app in a broken state.</p>\n<p>One possibility to prevent broken deployments is to use an HTTP-level check defined in section <a href=\"https://fly.io/docs/reference/configuration/#http_service-checks\">http_service.http_checks</a>. This type of check can be used to ensure that the app for real is in a functional state. </p>\n<p>Add a simple endpoint for doing an application health check to the backend. You may e.g. copy this code:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/health'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ok'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Configure then an <a href=\"https://fly.io/docs/reference/configuration/#http_service-checks\">HTTP check</a> that ensures the health of the deployments based on the HTTP request to the defined health check endpoint.</p>\n<p>You also need to set the <a href=\"https://fly.io/docs/reference/configuration/#picking-a-deployment-strategy\">deployment strategy</a> (in the file <em>fly.toml</em>) of the app to be either <i>canary</i> or <i>bluegreen</i>. These strategies ensure that only an app with a healthy state gets deployed.</p>\n<p>Ensure that GitHub Actions notices if a deployment breaks your application:</p>\n<picture><img src=\"/static/4088192d7642ea4b1f2e076e9aa5c7e7/5a190/fly-fail.png\" srcset=\"/static/4088192d7642ea4b1f2e076e9aa5c7e7/772e8/fly-fail.png 200w,\n/static/4088192d7642ea4b1f2e076e9aa5c7e7/e17e5/fly-fail.png 400w,\n/static/4088192d7642ea4b1f2e076e9aa5c7e7/5a190/fly-fail.png 800w,\n/static/4088192d7642ea4b1f2e076e9aa5c7e7/c1b63/fly-fail.png 1200w,\n/static/4088192d7642ea4b1f2e076e9aa5c7e7/29007/fly-fail.png 1600w,\n/static/4088192d7642ea4b1f2e076e9aa5c7e7/9ce1c/fly-fail.png 1886w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>You may simulate this e.g. as follows:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/health'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// eslint-disable-next-line no-constant-condition</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error...  '</span><span class=\"token punctuation\">)</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ok'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n</div>\n<div class=\"tasks\">\n<h3>Exercises 11.10-11.12. (Render)</h3>\n<p>If you rather want to use other hosting options, there is an alternative set of exercises for <a href=\"/en/part11/deployment/#exercises-11-10-11-12-fly-io\">Fly.io</a>.</p>\n<h4>11.10 Deploying your application to Render</h4>\n<p>Set up your application in <a href=\"https://render.com/\">Render</a>. The setup is now not quite as straightforward as in <a href=\"/en/part3/deploying_app_to_internet#application-to-the-internet\">part 3</a>. You have to carefully think about what should go to these settings:</p>\n<picture><img src=\"/static/8cfe69610a14255c0d99daeaaaed9cdb/5a190/render1.png\" srcset=\"/static/8cfe69610a14255c0d99daeaaaed9cdb/772e8/render1.png 200w,\n/static/8cfe69610a14255c0d99daeaaaed9cdb/e17e5/render1.png 400w,\n/static/8cfe69610a14255c0d99daeaaaed9cdb/5a190/render1.png 800w,\n/static/8cfe69610a14255c0d99daeaaaed9cdb/c1b63/render1.png 1200w,\n/static/8cfe69610a14255c0d99daeaaaed9cdb/29007/render1.png 1600w,\n/static/8cfe69610a14255c0d99daeaaaed9cdb/5ab15/render1.png 2446w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>If you need to run several commands in the build or start command, you may use a simple shell script for that.</p>\n<p>Create eg. a file <i>build_step.sh</i> with the following content:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Build script\"</span>\n\n<span class=\"token comment\"># add the commands here</span></code></pre></div>\n<p>Give it execution permissions (Google or see e.g. <a href=\"https://www.guru99.com/file-permissions.html\">this</a> to find out how) and ensure that you can run it from the command line:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ ./build_step.sh\nBuild script</code></pre></div>\n<p>Other option is to use a <a href=\"https://docs.render.com/deploys#deploy-steps\">Pre deploy command</a>, with that you may run one additional command before the deployment starts.</p>\n<p>You also need to open the <i>Advanced settings</i> and turn the auto-deploy off since we want to control the deployment in the GitHub Actions:</p>\n<picture><img src=\"/static/426739435ce30b5d2f24e6211912a7e8/5a190/render2.png\" srcset=\"/static/426739435ce30b5d2f24e6211912a7e8/772e8/render2.png 200w,\n/static/426739435ce30b5d2f24e6211912a7e8/e17e5/render2.png 400w,\n/static/426739435ce30b5d2f24e6211912a7e8/5a190/render2.png 800w,\n/static/426739435ce30b5d2f24e6211912a7e8/c1b63/render2.png 1200w,\n/static/426739435ce30b5d2f24e6211912a7e8/29007/render2.png 1600w,\n/static/426739435ce30b5d2f24e6211912a7e8/63908/render2.png 2410w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Ensure now that you get the app up and running. Use the <i>Manual deploy</i>.</p>\n<p>Most likely things will fail at the start, so remember to keep the <i>Logs</i> open all the time.</p>\n<h4>11.11 Automatic deployments</h4>\n<p>Next step is to automate the deployment. There are two options, a ready-made custom action or the use of the Render deploy hook.</p>\n<p><strong>Deployment with custom action</strong></p>\n<p>Go to GitHub Actions <a href=\"https://github.com/marketplace\">marketplace</a> and search for action for our purposes. You might search with <i>render deploy</i>. There are several actions to choose from. You can pick any. Quite often the best choice is the one with the most stars. It is also a good idea to look if the action is actively maintained (time of the last release) and does it has many open issues or pull requests. </p>\n<p><strong>Warning</strong>: for some reason, the most starred option <a href=\"https://github.com/Bounceapp/render-action\">render-action</a> was very unreliable when the part was updated (16th Jan 2024), so better avoid that. If you end up with too much problems, the deploy hook might be a better option!</p>\n<p>Set up the action to your workflow and ensure that every commit that passes all the checks results in a new deployment. Note that you need Render API key and the app service id for the deployment. See <a href=\"https://render.com/docs/api\">here</a> how the API key is generated. You can get the service id from the URL of the Render dashboard of your app. The end of the URL (starting with <em>srv-</em>) is the id:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">https://dashboard.render.com/web/srv-randomcharachtershere</code></pre></div>\n<p><strong>Deployment with deploy hook</strong></p>\n<p>Alternative, and perhaps a more reliable option is to use <a href=\"https://render.com/docs/deploy-hooks\">Render Deploy Hook</a> which is a private URL to trigger the deployment. You can get it from your app settings:</p>\n<img src=\"https://user-images.githubusercontent.com/47830671/230722899-1ebb414e-ae1e-4a5e-a7b8-f376c4f1ca4d.png\" alt=\"fsorender1\">\n<p>DON'T USE the plain URL in your pipeline. Instead create GitHub secrets for your key and service id: <img src=\"https://user-images.githubusercontent.com/47830671/230723138-77d027be-3162-4697-987e-b654bc710187.png\" alt=\"fsorender2\">\nThen you can use them like this: </p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">- name: Trigger deployment\n  run: <span class=\"token function\">curl</span> https://api.render.com/deploy/srv-<span class=\"token variable\">${{ secrets.RENDER_SERVICE_ID }</span><span class=\"token punctuation\">}</span>?key<span class=\"token operator\">=</span><span class=\"token variable\">${{ secrets.RENDER_API_KEY }</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>The deployment takes some time. See the events tab of the Render dashboard to see when the new deployment is ready:</p>\n<picture><img src=\"/static/b65d12907d88b6423df27d336c50c5bd/5a190/render3.png\" srcset=\"/static/b65d12907d88b6423df27d336c50c5bd/772e8/render3.png 200w,\n/static/b65d12907d88b6423df27d336c50c5bd/e17e5/render3.png 400w,\n/static/b65d12907d88b6423df27d336c50c5bd/5a190/render3.png 800w,\n/static/b65d12907d88b6423df27d336c50c5bd/c1b63/render3.png 1200w,\n/static/b65d12907d88b6423df27d336c50c5bd/29007/render3.png 1600w,\n/static/b65d12907d88b6423df27d336c50c5bd/cbe7f/render3.png 2420w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<h4>11.12 Health check</h4>\n<p>All tests pass and the new version of the app gets automatically deployed to Render so everything seems to be in order. But does the app really work? Besides the checks done in the deployment pipeline, it is extremely beneficial to have also some \"application level\" health checks ensuring that the app for real is in a functional state.</p>\n<p>The <a href=\"https://docs.render.com/deploys#zero-downtime-deploys\">zero downtime deploys</a> in Render should ensure that your app stays functional all the time! For some reason, this property did not always work as promised when this part was updated (16th Jan 2024). The reason might be the use of a free account.</p>\n<p>Add a simple endpoint for doing an application health check to the backend. You may e.g. copy this code:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/health'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ok'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Commit the code and push it to GitHub. Ensure that you can access the health check endpoint of your app.</p>\n<p>Configure now a <i>Health Check Path</i> to your app. The configuration is done in the settings tab of the Render dashboard.</p>\n<p>Make a change in your code, push it to GitHub, and ensure that the deployment succeeds.</p>\n<p>Note that you can see the log of deployment by clicking the most recent deployment in the events tab.</p>\n<p>When you are set up with the health check, simulate a broken deployment by changing the code as follows:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/health'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// eslint-disable-next-line no-constant-condition</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error...  '</span><span class=\"token punctuation\">)</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ok'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Push the code to GitHub and ensure that a broken version does not get deployed and the previous version of the app keeps running.</p>\n<p>Before moving on, fix your deployment and ensure that the application works again as intended.</p>\n</div>","frontmatter":{"mainImage":{"publicURL":"/static/56e5de2c8009789795a87071b1067167/part-11.svg"},"part":11,"letter":"c","lang":"en"}}},"pageContext":{"part":11,"letter":"c","lang":"en"}},"staticQueryHashes":["3128451518"]}